#!/usr/bin/env python

import os


__dirname__ = os.path.dirname(__file__)


def print_section_title(title):
    l = "    ------------------------------------------------"
    align_spaces = ((len(l) - 4 - len(title)) >> 1)
    align_spaces = max([align_spaces, 0]) * " "
    print(l)
    print("    " + align_spaces + title)
    print(l)


def activate_and_do(*cmds):
    # TODO(platforms): use platform specific activation and "&&"
    activate = "source ./venv/bin/activate"
    return os.system(f"{activate} && {' && '.join(cmds)}")


def create_venv():
    print_section_title("ğŸ“¦ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ¦Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„ØªØ´ØºÙŠÙ„ Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø§ÙŠØ«ÙˆÙ† ...")
    os.chdir(__dirname__)

    if not os.path.exists("./Ù…ØªØ·Ù„Ø¨Ø§Øª"):
        os.sys.stderr.write("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª\n")
        exit(1)

    ec = os.system("python -m venv venv") # TODO(platforms)
    if not ec:
        ec = activate_and_do("pip install -r Ù…ØªØ·Ù„Ø¨Ø§Øª")
        if ec:
            os.sys.stderr.write(
                "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ†ØµÙŠØ¨ Ø§Ù„Ø­Ø²Ùˆ Ù…Ù† Ù…Ù„Ù ./Ù…ØªØ·Ù„Ø¨Ø§Øª\n")
            exit(ec)
    else:
        os.sys.stderr.write("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ¦Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø¨Ø§ÙŠØ«ÙˆÙ†\n")
        exit(ec)


def build_alif():
    print_section_title("ğŸš€ Ø¬Ø§Ø±ÙŠ Ø¨Ù†Ø§Ø¡ Ù…ØªØ±Ø¬Ù… Ø£Ù„Ù ...")
    # TODO(platforms): check privileges
    if os.environ.get("USER") != "root":
        os.sys.stderr.write("ÙŠØ¬Ø¨ ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ø¨ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø°Ø±ØŒ Ø§Ø³ØªØ®Ø¯Ù… `sudo`\n")
        exit(1)
    build_dir = os.path.join(__dirname__, "../build")
    if not os.path.exists(build_dir):
        os.system(f'mkdir -p "{build_dir}"')
    os.chdir(build_dir)
    # TODO(platforms): different build commands in different platforms platforms
    os.system("cmake .. && make && sudo make install")


if __name__ == "__main__":
    os.chdir(__dirname__)
    if not os.path.exists("./venv"):
        create_venv()
    args = os.sys.argv[1:]
    if os.sys.argv[1:].count("--Ø§Ø¨Ù†-Ø£Ù„Ù") > 0:
        build_alif()
        args = filter(lambda a: a != "--Ø§Ø¨Ù†-Ø£Ù„Ù", args)
    args = map(lambda a: f"'{a}'", args)
    print_section_title("ğŸ” Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ...")
    os.chdir(__dirname__)
    activate_and_do(f"python ./Ø§Ø¬Ø±Ø§Ø¡_Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª {' '.join(args)}")
